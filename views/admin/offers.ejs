<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Manage Offers</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #ffffff;
        color: #000000;
      }
      .main-content {
        background-color: #ffffff;
      }
      .table-container {
        background-color: #edf4f5;
        padding: 20px;
        border-radius: 8px;
      }
      .table {
        background-color: #eef5f6;
        color: #000000;
      }
      .table th {
        background-color: #d1e7e9;
        color: #000000;
        text-transform: uppercase;
        font-size: 12px;
        border: none;
      }
      .table td {
        background-color: #fbfdfd;
        color: #000000;
        border: none;
        font-size: 14px;
      }
      .table tr {
        border-bottom: 1px solid #f5f8fa;
      }
      .btn-edit {
        background-color: #3498db;
        border: none;
        color: #ffffff;
        font-size: 12px;
        padding: 5px 15px;
        border-radius: 5px;
      }
      .btn-delete {
        background-color: #dc3545;
        border: none;
        color: #ffffff;
        font-size: 12px;
        padding: 5px 15px;
        border-radius: 5px;
      }
      .btn-add-offer {
        background-color: #2ecc71;
        border: none;
        color: #ffffff;
        font-size: 14px;
        padding: 8px 20px;
        border-radius: 5px;
        float: right;
        margin-bottom: 15px;
      }
      .search-bar {
        background-color: #ffffff;
        border: 1px solid #ced4da;
        color: #000000;
        padding: 5px 10px;
        border-radius: 5px;
        margin-bottom: 15px;
      }
      .btn-search,
      .btn-clear {
        background-color: #2ecc71;
        border: none;
        color: #ffffff;
        font-size: 12px;
        padding: 5px 15px;
        border-radius: 5px;
        margin-left: 5px;
      }
      .btn-clear {
        background-color: #7f8c8d;
      }
      .form-control,
      .form-select {
        background-color: #ffffff;
        color: #000000;
        border: 1px solid #ced4da;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Header & Sidebar -->
        <%- include('../partials/admin/header') %>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 main-content py-4">
          <h3 class="text-center mb-4 text-dark">Admin - Manage Offers</h3>

          <% if (error) { %>
            <div class="alert alert-danger" id="errorAlert"><%= error %></div>
          <% } %>

          <!-- Declare visibleProducts once at the top -->
          <% const visibleProducts = products.filter(p => !p.isBlocked); %>

          <!-- Consolidated Offers Table -->
          <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <input
                type="text"
                class="search-bar"
                id="searchInput"
                placeholder="Search for Offers"
              />
              <div>
                <button class="btn btn-search" onclick="searchOffers()">Search</button>
                <button class="btn btn-clear" onclick="clearSearch()">Clear</button>
              </div>
            </div>
            <button
              type="button"
              class="btn btn-add-offer"
              data-bs-toggle="modal"
              data-bs-target="#addOfferModal"
            >
              Add Offer +
            </button>
            <table class="table" id="offerTable">
              <thead>
                <tr>
                  <th>Offer Name</th>
                  <th>Offer Type</th>
                  <th>Applicable</th>
                  <th>Offer Amount</th>
                  <th>Valid From</th>
                  <th>Valid Upto</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Product Offers -->
                <% productOffers.forEach(offer => { %>
                  <tr data-id="<%= offer._id %>" data-type="product" data-name="<%= (offer.offerName || 'Product Offer').toLowerCase() %>">
                    <td class="offer-name"><%= offer.offerName || 'Product Offer' %></td>
                    <td class="offer-type">Product</td>
                    <td class="applicable"><%= offer.product?.productName || 'Unknown' %></td>
                    <td class="offer-amount"><%= offer.discount %>%</td>
                    <td class="valid-from"><%= new Date(offer.startDate).toLocaleDateString() %></td>
                    <td class="valid-upto"><%= new Date(offer.endDate).toLocaleDateString() %></td>
                    <td>
                      <button
                        class="btn btn-edit"
                        data-bs-toggle="modal"
                        data-bs-target="#editOfferModal"
                        data-id="<%= offer._id %>"
                        data-type="product"
                        data-offer-name="<%= offer.offerName || 'Product Offer' %>"
                        data-product-id="<%= offer.product?._id || '' %>"
                        data-discount="<%= offer.discount %>"
                        data-start-date="<%= offer.startDate.toISOString().split('T')[0] %>"
                        data-end-date="<%= offer.endDate.toISOString().split('T')[0] %>"
                      >
                        Edit
                      </button>
                      <button
                        class="btn btn-delete"
                        onclick="deleteOffer('<%= offer._id %>', 'product')"
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                <% }) %>

                <!-- Category Offers -->
                <% categoryOffers.forEach(offer => { %>
                  <tr data-id="<%= offer._id %>" data-type="category" data-name="<%= (offer.offerName || 'Category Offer').toLowerCase() %>">
                    <td class="offer-name"><%= offer.offerName || 'Category Offer' %></td>
                    <td class="offer-type">Category</td>
                    <td class="applicable"><%= offer.category?.name || 'Unknown' %></td>
                    <td class="offer-amount"><%= offer.discount %>%</td>
                    <td class="valid-from"><%= new Date(offer.startDate).toLocaleDateString() %></td>
                    <td class="valid-upto"><%= new Date(offer.endDate).toLocaleDateString() %></td>
                    <td>
                      <button
                        class="btn btn-edit"
                        data-bs-toggle="modal"
                        data-bs-target="#editOfferModal"
                        data-id="<%= offer._id %>"
                        data-type="category"
                        data-offer-name="<%= offer.offerName || 'Category Offer' %>"
                        data-category-id="<%= offer.category?._id || '' %>"
                        data-discount="<%= offer.discount %>"
                        data-start-date="<%= offer.startDate.toISOString().split('T')[0] %>"
                        data-end-date="<%= offer.endDate.toISOString().split('T')[0] %>"
                      >
                        Edit
                      </button>
                      <button
                        class="btn btn-delete"
                        onclick="deleteOffer('<%= offer._id %>', 'category')"
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Offer Modal -->
    <div
      class="modal fade"
      id="addOfferModal"
      tabindex="-1"
      aria-labelledby="addOfferModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addOfferModalLabel">Add New Offer</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addOfferForm" action="/admin/add-offer" method="POST">
              <div class="mb-3">
                <label for="offerType" class="form-label">Offer Type</label>
                <select name="offerType" id="offerType" class="form-select"  onchange="toggleOfferFields()">
                  <option value="">Select Offer Type</option>
                  <option value="product">Product Offer</option>
                  <option value="category">Category Offer</option>
                </select>
              </div>
              <div class="mb-3" id="productField" style="display: none;">
                <label for="productId" class="form-label">Select Product</label>
                <select name="productId" id="productId" class="form-select">
                  <% if (visibleProducts.length) { %>
                    <% visibleProducts.forEach(product => { %>
                      <option value="<%= product._id %>">
                        <%= product.productName %>
                      </option>
                    <% }) %>
                  <% } else { %>
                    <option value="">No products available</option>
                  <% } %>
                </select>
              </div>
              <div class="mb-3" id="categoryField" style="display: none;">
                <label for="categoryId" class="form-label">Select Category</label>
                <select name="categoryId" id="categoryId" class="form-select">
                  <% if (categories && categories.length) { %>
                    <% categories.forEach(category => { %>
                      <option value="<%= category._id %>">
                        <%= category.name %>
                      </option>
                    <% }) %>
                  <% } else { %>
                    <option value="">No categories available</option>
                  <% } %>
                </select>
              </div>
              <div class="mb-3">
                <label for="offerName" class="form-label">Offer Name</label>
                <input type="text" name="offerName" id="offerName" class="form-control"  />
              </div>
              <div class="mb-3">
                <label for="discount" class="form-label">Discount (%)</label>
                <input type="number" name="discount" id="discount" class="form-control"  min="0" max="100" />
              </div>
              <div class="mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" name="startDate" id="startDate" class="form-control"  />
              </div>
              <div class="mb-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" name="endDate" id="endDate" class="form-control"  />
              </div>
              <button type="submit" class="btn btn-primary">Add Offer</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Offer Modal -->
    <div
      class="modal fade"
      id="editOfferModal"
      tabindex="-1"
      aria-labelledby="editOfferModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editOfferModalLabel">Edit Offer</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editOfferForm">
              <input type="hidden" name="offerId" id="editOfferId" />
              <input type="hidden" name="offerType" id="editOfferType" />
              <div class="mb-3">
                <label for="editOfferName" class="form-label">Offer Name</label>
                <input
                  type="text"
                  name="offerName"
                  id="editOfferName"
                  class="form-control"
                 
                />
              </div>
              <div class="mb-3" id="editProductField">
                <label for="editProductId" class="form-label">Select Product</label>
                <select name="productId" id="editProductId" class="form-select">
                  <% if (visibleProducts.length) { %>
                    <% visibleProducts.forEach(product => { %>
                      <option value="<%= product._id %>">
                        <%= product.productName %>
                      </option>
                    <% }) %>
                  <% } else { %>
                    <option value="">No products available</option>
                  <% } %>
                </select>
              </div>
              <div class="mb-3" id="editCategoryField">
                <label for="editCategoryId" class="form-label">Select Category</label>
                <select name="categoryId" id="editCategoryId" class="form-select">
                  <% if (categories && categories.length) { %>
                    <% categories.forEach(category => { %>
                      <option value="<%= category._id %>">
                        <%= category.name %>
                      </option>
                    <% }) %>
                  <% } else { %>
                    <option value="">No categories available</option>
                  <% } %>
                </select>
              </div>
              <div class="mb-3">
                <label for="editDiscount" class="form-label">Discount (%)</label>
                <input
                  type="number"
                  name="discount"
                  id="editDiscount"
                  class="form-control"
                  required
                  min="0"
                  max="100"
                />
              </div>
              <div class="mb-3">
                <label for="editStartDate" class="form-label">Start Date</label>
                <input
                  type="date"
                  name="startDate"
                  id="editStartDate"
                  class="form-control"
                 
                />
              </div>
              <div class="mb-3">
                <label for="editEndDate" class="form-label">End Date</label>
                <input
                  type="date"
                  name="endDate"
                  id="editEndDate"
                  class="form-control"
                
                />
              </div>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Utility function to display alerts
      function showAlert(message, type = "danger") {
        const alertContainer = document.createElement("div");
        alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
        alertContainer.role = "alert";
        alertContainer.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        const existingAlert = document.getElementById("errorAlert");
        if (existingAlert) {
          existingAlert.remove();
        }
        document.querySelector(".main-content").prepend(alertContainer);
      }

      // Search Offers
      function searchOffers() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.querySelectorAll("#offerTable tbody tr");

        rows.forEach(row => {
          const offerName = row.getAttribute("data-name");
          if (offerName.includes(searchTerm)) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      // Clear Search
      function clearSearch() {
        document.getElementById("searchInput").value = "";
        const rows = document.querySelectorAll("#offerTable tbody tr");
        rows.forEach(row => {
          row.style.display = "";
        });
      }

      // Toggle Offer Fields in Add Offer Modal
      function toggleOfferFields() {
        const offerType = document.getElementById("offerType").value;
        document.getElementById("productField").style.display =
          offerType === "product" ? "block" : "none";
        document.getElementById("categoryField").style.display =
          offerType === "category" ? "block" : "none";
      }

      // Populate Edit Offer Modal
      document.querySelectorAll(".btn-edit").forEach(button => {
        button.addEventListener("click", function () {
          const offerId = this.getAttribute("data-id");
          const offerType = this.getAttribute("data-type");
          const offerName = this.getAttribute("data-offer-name");
          const productId = this.getAttribute("data-product-id");
          const categoryId = this.getAttribute("data-category-id");
          const discount = this.getAttribute("data-discount");
          const startDate = this.getAttribute("data-start-date");
          const endDate = this.getAttribute("data-end-date");

          console.log("Populating Edit Modal:", {
            offerId,
            offerType,
            offerName,
            productId,
            categoryId,
            discount,
            startDate,
            endDate
          });

          document.getElementById("editOfferId").value = offerId;
          document.getElementById("editOfferType").value = offerType;
          document.getElementById("editOfferName").value = offerName;
          document.getElementById("editDiscount").value = discount;
          document.getElementById("editStartDate").value = startDate;
          document.getElementById("editEndDate").value = endDate;

          document.getElementById("editProductField").style.display =
            offerType === "product" ? "block" : "none";
          document.getElementById("editCategoryField").style.display =
            offerType === "category" ? "block" : "none";

          if (offerType === "product" && productId) {
            document.getElementById("editProductId").value = productId;
          } else if (offerType === "category" && categoryId) {
            document.getElementById("editCategoryId").value = categoryId;
          }
        });
      });

      // Client-Side Validation and AJAX for Edit Offer Form
      document.getElementById("editOfferForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const startDate = new Date(document.getElementById("editStartDate").value);
        const endDate = new Date(document.getElementById("editEndDate").value);
        if (startDate >= endDate) {
          showAlert("Start date must be before end date");
          return;
        }

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        const offerType = data.offerType;
        const endpoint = offerType === "product"
          ? `/admin/edit-product-offer/${data.offerId}`
          : `/admin/edit-category-offer/${data.offerId}`;

        console.log("Submitting Edit Offer Form:", data);
        console.log("Endpoint:", endpoint);

        try {
          const response = await fetch(endpoint, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              offerId: data.offerId,
              offerName: data.offerName,
              productId: data.productId,
              categoryId: data.categoryId,
              discount: Number(data.discount),
              startDate: data.startDate,
              endDate: data.endDate,
            }),
          });

          console.log("Response Status:", response.status);
          const result = await response.json();
          console.log("Response Data:", result);

          if (!response.ok) {
            throw new Error(result.error || "Failed to edit offer");
          }

          // Update the table row dynamically
          const row = document.querySelector(`tr[data-id="${data.offerId}"][data-type="${offerType}"]`);
          row.querySelector(".offer-name").textContent = data.offerName;
          row.querySelector(".applicable").textContent = offerType === "product"
            ? document.querySelector(`#editProductId option[value="${data.productId}"]`)?.text || "Unknown"
            : document.querySelector(`#editCategoryId option[value="${data.categoryId}"]`)?.text || "Unknown";
          row.querySelector(".offer-amount").textContent = `${data.discount}%`;
          row.querySelector(".valid-from").textContent = new Date(data.startDate).toLocaleDateString();
          row.querySelector(".valid-upto").textContent = new Date(data.endDate).toLocaleDateString();
          row.setAttribute("data-name", data.offerName.toLowerCase());

          // Update the Edit button's data attributes
          const editButton = row.querySelector(".btn-edit");
          editButton.setAttribute("data-offer-name", data.offerName);
          editButton.setAttribute("data-product-id", data.productId || "");
          editButton.setAttribute("data-category-id", data.categoryId || "");
          editButton.setAttribute("data-discount", data.discount);
          editButton.setAttribute("data-start-date", data.startDate);
          editButton.setAttribute("data-end-date", data.endDate);

          // Close the modal
          const modal = bootstrap.Modal.getInstance(document.getElementById("editOfferModal"));
          modal.hide();

          showAlert("Offer updated successfully", "success");
        } catch (error) {
          console.error("Error editing offer:", error);
          showAlert(error.message);
        }
      });

      // AJAX for Delete Offer
      async function deleteOffer(offerId, offerType) {
        if (!confirm("Are you sure you want to delete this offer?")) {
          return;
        }

        const endpoint = offerType === "product"
          ? `/admin/delete-product-offer/${offerId}`
          : `/admin/delete-category-offer/${offerId}`;

        try {
          const response = await fetch(endpoint, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || "Failed to delete offer");
          }

          // Remove the table row dynamically
          const row = document.querySelector(`tr[data-id="${offerId}"][data-type="${offerType}"]`);
          row.remove();

          showAlert("Offer deleted successfully", "success");
        } catch (error) {
          console.error("Error deleting offer:", error);
          showAlert(error.message);
        }
      }

      // Client-Side Validation for Add Offer Form
      document.getElementById("addOfferForm").addEventListener("submit", function (e) {
        const startDate = new Date(document.getElementById("startDate").value);
        const endDate = new Date(document.getElementById("endDate").value);
        if (startDate >= endDate) {
          e.preventDefault();
          alert("Start date must be before end date");
          return;
        }

        const formData = new FormData(this);
        console.log("Add Offer Form Submitted:", Object.fromEntries(formData));
      });
    </script>
  </body>
</html>