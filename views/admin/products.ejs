<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management System</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      background-color: #f5f5f5;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    .product-container {
      background-color: white;
      border-radius: 8px;
      padding: 60px;
      margin-top: 20px;
      margin-left: 230px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .search-container {
      background-color: #C6A969;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .table th {
      background-color: #C6A969;
      color: white;
    }
    .btn-add-product {
      background-color: #C6A969;
      color: white;
    }
    .product-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
    }
    .table-responsive {
      overflow-x: auto;
    }
    .image-preview-item {
      position: relative;
      margin-bottom: 15px;
    }
    .image-preview-item img {
      max-width: 100%;
      border: 1px solid #ddd;
    }
    .image-preview-item .remove-image {
      position: absolute;
      top: 5px;
      right: 20px;
      background: rgba(255,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      line-height: 25px;
      text-align: center;
      cursor: pointer;
    }
    .cropper-container {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container product-container">
    <div class="row mb-3">
      <%-include("../partials/admin/header")%>
      <div class="col-md-6">
        <h2>Products</h2>
      </div>
      <div class="col-md-6 text-end">
        <button class="btn btn-add-product" id="addProductBtn">
          Add Product+
        </button>
      </div>
    </div>
     
  <form action="/admin/products" method="get" id="searchForm">
    <div class="search-container">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Search products or brands" value="<%= search %>"
            id="searchInput" name="search">
            <button class="btn btn-light" type="submit">Search</button>
            <button type="button" class="btn btn-secondary ms-2" id="clearBtn">
              Clear
          </button>
          </div>
        </div>
      </div>
    </div>
  </form>

    <div class="table-responsive">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Product Name</th>
            <th>Image</th>
            <th>Brand</th>
            <th>Category</th>
            <th>Sale Price</th>
            <th>Quantity</th>
            <th>Block/Unblock</th>
            <th>Edit</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          <% if (products.length === 0) { %>
            <tr>
              <td colspan="9" class="text-center">No products found</td>
            </tr>
          <% } else { %>
            <% for(let i=0; i<products.length; i++) { %>
              <tr>
                <td><%= products[i].productName %></td>
                <td><img src="<%= products[i].productImage[0] || '/placeholder.jpg' %>" height="25em" alt=""></td>
                <td><%= products[i].brand?.name || 'Unknown Brand' %></td>
                <td><%= products[i].category?.name || 'Unknown Category' %></td>
                <td><%= products[i].salePrice %></td>
                <td><%= products[i].quantity %></td>
                <td>
                  <% if(products[i].isListed === false) { %>
                    <button class="btn btn-danger btn-sm" 
                            onclick="confirmList('<%= products[i]._id %>', true, this)">LIST</button>
                  <% } else { %>
                    <button class="btn btn-success" style="width: 100px;" 
                            onclick="confirmList('<%= products[i]._id %>', false, this)">UNLIST</button>
                  <% } %>
                </td>
                <td>
                  <button class="btn btn-sm" 
                          style="background-color: #C6A969;"
                          data-product="<%- JSON.stringify(products[i]).replace(/"/g, '&quot;') %>" 
                          onclick="openEditModalFromBtn(this)">Edit</button>
                </td>
                <td>
                  <button class="btn btn-sm" 
                          style="background-color: #C6A969;"
                          onclick="confirmDelete('<%= products[i]._id %>')">Delete</button>
                </td>
              </tr>
            <% } %>
          <% } %>
        </tbody>
      </table>
      <!-- Pagination -->
     <!-- Pagination -->
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
      <% if (currentPage> 1) { %>
          <li class="page-item">
              <a class="page-link" href="?page=<%= currentPage - 1 %>" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
              </a>
          </li>
          <% } %>
              <% for(let i=1; i <=totalPages; i++) { %>
                  <% if(i===currentPage) { %>
                      <li class="page-item active">
                          <a class="page-link" href="?page=<%= i %>">
                              <%= i %>
                          </a>
                      </li>
                      <% } else { %>
                          <li class="page-item">
                              <a class="page-link" href="?page=<%= i %>">
                                  <%= i %>
                              </a>
                          </li>
                          <% } %>
                              <% } %>
                                  <% if(currentPage < totalPages) { %>
                                      <li class="page-item">
                                          <a class="page-link" href="?page=<%= currentPage + 1 %>"
                                              aria-label="Next">
                                              <span aria-hidden="true">&raquo;</span>
                                          </a>
                                      </li>
                                      <% } %>
  </ul>
</nav>

<style>
  .pagination .page-link {
      color: #C6A969;
      border-color: #e9ecef;
  }
  
  .pagination .page-item.active .page-link {
      background-color: #C6A969;
      border-color: #C6A969;
      color: white;
  }
  
  .pagination .page-link:hover {
      background-color: #f8f9fa;
      color: #C6A969;
      border-color: #e9ecef;
  }
  
  .pagination .page-link:focus {
      box-shadow: 0 0 0 0.25rem rgba(198, 169, 105, 0.25);
  }
</style>

    </div>
  </div>

  <!-- Add Product Modal -->
  <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header text-white" style="background-color: #C6A969;">
          <h5 class="modal-title">Add New Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="productForm" action="/admin/add-product" method="post" enctype="multipart/form-data">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="productName" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="productName" name="productName" required>
              </div>
              <div class="col-md-6">
                <label for="brand" class="form-label">Brand</label>
                <select class="form-select" id="brand" name="brand" required>
                  <option value="" disabled selected>Select Brand</option>
                  <% for(let i=0; i<brand.length; i++) { %>
                  <option value="<%= brand[i]._id %>">
                    <%= brand[i].name %>
                  </option>
                  <% } %>
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category" name="category" required>
                  <option value="" disabled selected>Select Category</option>
                  <% for(let i=0; i<cat.length; i++) { %>
                  <option value="<%= cat[i]._id %>">
                    <%= cat[i].name %>
                  </option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-6">
                <label for="salePrice" class="form-label">Sale Price</label>
                <input type="number" class="form-control" id="salePrice" name="salePrice" step="0.01" required>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="material" class="form-label">Material</label>
                <input type="text" class="form-control" id="material" name="material" required>
              </div>
              <div class="col-md-6">
                <label for="quantity" class="form-label">Quantity</label>
                <input type="number" class="form-control" id="quantity" name="quantity" required>
              </div>
            </div>
            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label for="imageUpload" class="form-label">Product Images (Select at least 3 images)</label>
              <input type="file" class="form-control" id="imageUpload" name="images" accept="image/png, image/jpeg, image/jpg" multiple required>
              <div id="imageValidationMessage" class="form-text text-danger"></div>
            </div>
            <div id="imagePreviewContainer" class="row mt-3">
              <p>Selected images will appear here for preview and cropping</p>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" id="saveProduct" style="background-color: #C6A969; border-color: #C6A969;">Save Product</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header text-white" style="background-color: #C6A969;">
          <h5 class="modal-title">Edit Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editProductForm" action="/admin/edit-product" method="post" enctype="multipart/form-data">
            <input type="hidden" id="editProductId" name="productId">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editProductName" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="editProductName" name="productName" required>
              </div>
              <div class="col-md-6">
                <label for="editBrand" class="form-label">Brand</label>
                <select class="form-select" id="editBrand" name="brand" required>
                  <option value="" disabled>Select Brand</option>
                  <% for(let i=0; i<brand.length; i++) { %>
                  <option value="<%= brand[i]._id %>">
                    <%= brand[i].name %>
                  </option>
                  <% } %>
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editCategory" class="form-label">Category</label>
                <select class="form-select" id="editCategory" name="category" required>
                  <option value="" disabled>Select Category</option>
                  <% for(let i=0; i<cat.length; i++) { %>
                  <option value="<%= cat[i]._id %>">
                    <%= cat[i].name %>
                  </option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-6">
                <label for="editSalePrice" class="form-label">Sale Price</label>
                <input type="number" class="form-control" id="editSalePrice" name="salePrice" step="0.01" required>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editMaterial" class="form-label">Material</label>
                <input type="text" class="form-control" id="editMaterial" name="material" required>
              </div>
              <div class="col-md-6">
                <label for="editQuantity" class="form-label">Quantity</label>
                <input type="number" class="form-control" id="editQuantity" name="quantity" required>
              </div>
            </div>
            <div class="mb-3">
              <label for="editDescription" class="form-label">Description</label>
              <textarea class="form-control" id="editDescription" name="description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label for="editImageUpload" class="form-label">Product Images (Select new images to replace or add)</label>
              <input type="file" class="form-control" id="editImageUpload" name="images" accept="image/png, image/jpeg, image/jpg" multiple>
              <div id="editImageValidationMessage" class="form-text text-danger"></div>
            </div>
            <div id="editImagePreviewContainer" class="row mt-3">
              <p>Existing and new images will appear here for preview and cropping</p>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" id="saveEditProduct" style="background-color: #C6A969; border-color: #C6A969;">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script>

document.getElementById("clearBtn").addEventListener("click", function() {
        document.getElementById("searchInput").value = "";
        document.getElementById("searchForm").submit();
    });


    // Add Product Modal
    document.addEventListener('DOMContentLoaded', function() {
      const addProductBtn = document.getElementById('addProductBtn');
      let addProductModal;
      
      addProductBtn.addEventListener('click', function() {
        addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
        addProductModal.show();
      });
    });

    const imageUpload = document.getElementById('imageUpload');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imageValidationMessage = document.getElementById('imageValidationMessage');
    const saveButton = document.getElementById('saveProduct');
    const form = document.getElementById('productForm');
    const processedImages = [];

    imageUpload.addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      imagePreviewContainer.innerHTML = '';
      imageValidationMessage.textContent = '';
      processedImages.length = 0;

      if (files.length < 3) {
        imageValidationMessage.textContent = 'Please select at least 3 images';
        return;
      }

      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const previewCol = document.createElement('div');
          previewCol.className = 'col-md-4 image-preview-item';
          const img = document.createElement('img');
          img.src = event.target.result;
          img.className = 'img-fluid mb-2';
          img.setAttribute('data-index', index);
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-image';
          removeBtn.innerHTML = '×';
          removeBtn.onclick = function() {
            previewCol.remove();
            processedImages[index] = null;
            const remainingImages = processedImages.filter(img => img !== null);
            if (remainingImages.length < 3) {
              imageValidationMessage.textContent = 'Please select at least 3 images';
            }
          };

          const cropBtn = document.createElement('button');
          cropBtn.className = 'btn btn-sm btn-outline-secondary w-100 mb-2';
          cropBtn.textContent = 'Crop Image';
          
          const cropperContainer = document.createElement('div');
          cropperContainer.className = 'cropper-container d-none';
          
          previewCol.appendChild(img);
          previewCol.appendChild(removeBtn);
          previewCol.appendChild(cropBtn);
          previewCol.appendChild(cropperContainer);
          imagePreviewContainer.appendChild(previewCol);
          
          processImage(file, img, index);
          
          cropBtn.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            if (cropperContainer.classList.contains('d-none')) {
              cropperContainer.classList.remove('d-none');
              const cropper = new Cropper(img, {
                aspectRatio: 1,
                viewMode: 1,
                ready: function() {
                  const confirmBtn = document.createElement('button');
                  confirmBtn.type = 'button';
                  confirmBtn.className = 'btn btn-sm btn-success mt-2 w-100';
                  confirmBtn.textContent = 'Confirm Crop';
                  cropperContainer.appendChild(confirmBtn);

                  confirmBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    const canvas = cropper.getCroppedCanvas({
                      width: 800,
                      height: 800,
                      imageSmoothingQuality: 'high',
                    });
                    img.src = canvas.toDataURL('image/jpeg');
                    canvas.toBlob(function(blob) {
                      processedImages[index] = new File([blob], `cropped-${file.name}`, {
                        type: 'image/jpeg',
                        lastModified: new Date().getTime(),
                      });
                      cropper.destroy();
                      cropperContainer.classList.add('d-none');
                      cropperContainer.innerHTML = '';
                    }, 'image/jpeg', 0.9);
                  });
                },
              });
            } else {
              cropperContainer.classList.add('d-none');
              cropperContainer.innerHTML = '';
            }
          });
        };
        reader.readAsDataURL(file);
      });
    });

    function processImage(file, imgElement, index) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const MAX_WIDTH = 1200;
        const MAX_HEIGHT = 1200;
        let width = img.width;
        let height = img.height;

        if (width > MAX_WIDTH || height > MAX_HEIGHT) {
          if (width > height) {
            if (width > MAX_WIDTH) {
              height *= MAX_WIDTH / width;
              width = MAX_WIDTH;
            }
          } else {
            if (height > MAX_HEIGHT) {
              width *= MAX_HEIGHT / height;
              height = MAX_HEIGHT;
            }
          }
        }

        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        canvas.toBlob(function(blob) {
          processedImages[index] = new File([blob], file.name, {
            type: file.type,
            lastModified: new Date().getTime()
          });
        }, file.type, 0.9);
      };
      img.src = URL.createObjectURL(file);
    }

    saveButton.addEventListener('click', function() {
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const validImages = processedImages.filter(img => img !== null);
      if (validImages.length < 3) {
        imageValidationMessage.textContent = 'Please select at least 3 images';
        return;
      }

      const formData = new FormData(form);
      formData.delete('images');
      validImages.forEach((image, i) => {
        formData.append('images', image);
      });

      fetch(form.action, {
        method: 'POST',
        body: formData,
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(errData => {
            throw new Error(errData.message || 'Server error occurred');
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: data.message || 'Product added successfully!',
            timer: 1500,
            showConfirmButton: true
          }).then(() => {
            window.location.reload();
          });
          const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
          modal.hide();
          form.reset();
          imagePreviewContainer.innerHTML = '';
        } else {
          Swal.fire({
            icon: 'error',
            title: data.message || 'Failed to add product',
            timer: 1500,
            showConfirmButton: false
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({
          icon: 'error',
          title: error.message || 'There was a problem adding the product. Please try again.',
          timer: 1500,
          showConfirmButton: false
        });
      });
    });

    // Edit Product Modal
    const editImageUpload = document.getElementById('editImageUpload');
    const editImagePreviewContainer = document.getElementById('editImagePreviewContainer');
    const editImageValidationMessage = document.getElementById('editImageValidationMessage');
    const editSaveButton = document.getElementById('saveEditProduct');
    const editForm = document.getElementById('editProductForm');
    const processedEditImages = [];
    let existingImages = [];

    function openEditModalFromBtn(button) {
      const product = JSON.parse(button.getAttribute('data-product'));
      openEditModal(product);
    }
    

    function openEditModal(product) {
  // Safely read nested _id fields
  const brandId    = product.brand   ? product.brand._id   : '';
  const categoryId = product.category? product.category._id: '';

  document.getElementById('editProductId').value        = product._id;
  document.getElementById('editProductName').value     = product.productName || '';
  document.getElementById('editBrand').value           = brandId;
  document.getElementById('editCategory').value        = categoryId;
  document.getElementById('editSalePrice').value       = product.salePrice  || '';
  document.getElementById('editMaterial').value        = product.material   || '';
  document.getElementById('editQuantity').value        = product.quantity   || '';
  document.getElementById('editDescription').value     = product.description|| '';

  // …rest of your code…
  


      editImagePreviewContainer.innerHTML = '';
      editImageValidationMessage.textContent = '';
      processedEditImages.length = 0;
      existingImages = [...product.productImage];

      existingImages.forEach((imageUrl, index) => {
        const previewCol = document.createElement('div');
        previewCol.className = 'col-md-4 image-preview-item';
        const img = document.createElement('img');
        img.src = imageUrl;
        img.className = 'img-fluid mb-2';
        img.setAttribute('data-index', index);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-image';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = function() {
          previewCol.remove();
          existingImages[index] = null;
          checkImageCount();
        };

        previewCol.appendChild(img);
        previewCol.appendChild(removeBtn);
        editImagePreviewContainer.appendChild(previewCol);
      });

     const editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
  editModal.show();
}
    editImageUpload.addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      editImageValidationMessage.textContent = '';

      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const previewCol = document.createElement('div');
          previewCol.className = 'col-md-4 image-preview-item';
          const img = document.createElement('img');
          img.src = event.target.result;
          img.className = 'img-fluid mb-2';
          img.setAttribute('data-index', index + existingImages.length);

          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-image';
          removeBtn.innerHTML = '×';
          removeBtn.onclick = function() {
            previewCol.remove();
            processedEditImages[index] = null;
            checkImageCount();
          };

          const cropBtn = document.createElement('button');
          cropBtn.className = 'btn btn-sm btn-outline-secondary w-100 mb-2';
          cropBtn.textContent = 'Crop Image';

          const cropperContainer = document.createElement('div');
          cropperContainer.className = 'cropper-container d-none';

          previewCol.appendChild(img);
          previewCol.appendChild(removeBtn);
          previewCol.appendChild(cropBtn);
          previewCol.appendChild(cropperContainer);
          editImagePreviewContainer.appendChild(previewCol);

          processImage(file, img, index);

          cropBtn.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            if (cropperContainer.classList.contains('d-none')) {
              cropperContainer.classList.remove('d-none');
              const cropper = new Cropper(img, {
                aspectRatio: 1,
                viewMode: 1,
                ready: function() {
                  const confirmBtn = document.createElement('button');
                  confirmBtn.type = 'button';
                  confirmBtn.className = 'btn btn-sm btn-success mt-2 w-100';
                  confirmBtn.textContent = 'Confirm Crop';
                  cropperContainer.appendChild(confirmBtn);

                  confirmBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    const canvas = cropper.getCroppedCanvas({
                      width: 800,
                      height: 800,
                      imageSmoothingQuality: 'high',
                    });
                    img.src = canvas.toDataURL('image/jpeg');
                    canvas.toBlob(function(blob) {
                      processedEditImages[index] = new File([blob], `cropped-${file.name}`, {
                        type: 'image/jpeg',
                        lastModified: new Date().getTime(),
                      });
                      cropper.destroy();
                      cropperContainer.classList.add('d-none');
                      cropperContainer.innerHTML = '';
                    }, 'image/jpeg', 0.9);
                  });
                },
              });
            } else {
              cropperContainer.classList.add('d-none');
              cropperContainer.innerHTML = '';
            }
          });
        };
        reader.readAsDataURL(file);
      });
    });

    function checkImageCount() {
      const totalImages = existingImages.filter(img => img !== null).length + 
                         processedEditImages.filter(img => img !== null).length;
      if (totalImages < 1) {
        editImageValidationMessage.textContent = 'Please ensure at least 1 image is present';
      } else {
        editImageValidationMessage.textContent = '';
      }
    }

    editSaveButton.addEventListener('click', function() {
      if (!editForm.checkValidity()) {
        editForm.reportValidity();
        return;
      }

      const totalImages = existingImages.filter(img => img !== null).length + 
                         processedEditImages.filter(img => img !== null).length;
      if (totalImages < 1) {
        editImageValidationMessage.textContent = 'Please ensure at least 1 image is present';
        return;
      }

      const formData = new FormData(editForm);
      formData.delete('images');
      processedEditImages.filter(img => img !== null).forEach((image, i) => {
        formData.append('images', image);
      });
      existingImages.forEach((image, index) => {
        if (image !== null) {
          formData.append('existingImages', image);
        }
      });

      fetch(editForm.action, {
        method: 'POST',
        body: formData,
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(errData => {
            throw new Error(errData.message || 'Server error occurred');
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: data.message || 'Product updated successfully!',
            timer: 1500,
            showConfirmButton: true
          }).then(() => {
            window.location.reload();
          });
          const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
          modal.hide();
          editForm.reset();
          editImagePreviewContainer.innerHTML = '';
        } else {
          Swal.fire({
            icon: 'error',
            title: data.message || 'Failed to update product',
            timer: 1500,
            showConfirmButton: false
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({
          icon: 'error',
          title: error.message || 'There was a problem updating the product. Please try again.',
          timer: 1500,
          showConfirmButton: false
        });
      });
    });

    // Block/Unblock Product
    // function confirmBlock(productId, block, button) {
    //   Swal.fire({
    //     title: block ? 'Block Product' : 'Unblock Product',
    //     text: `Are you sure you want to ${block ? 'block' : 'unblock'} this product?`,
    //     icon: 'warning',
    //     showCancelButton: true,
    //     confirmButtonColor: '#C6A969',
    //     cancelButtonColor: '#d33',
    //     confirmButtonText: 'Yes',
    //     cancelButtonText: 'No'
    //   }).then((result) => {
    //     if (result.isConfirmed) {
    //       fetch(`/admin/block-product/${productId}`, {
    //         method: 'PATCH',
    //         headers: {
    //           'Content-Type': 'application/json',
    //         },
    //         body: JSON.stringify({ isBlocked: block })
    //       })
    //       .then(response => {
    //         if (!response.ok) {
    //           throw new Error('Failed to update product status');
    //         }
    //         return response.json();
    //       })
    //       .then(data => {
    //         if (data.success) {
    //           Swal.fire({
    //             icon: 'success',
    //             title: block ? 'Product Blocked' : 'Product Unblocked',
    //             timer: 1500,
    //             showConfirmButton: false
    //           }).then(() => {
    //             window.location.reload();
    //           });
    //         } else {
    //           throw new Error(data.message || 'Failed to update product status');
    //         }
    //       })
    //       .catch(error => {
    //         Swal.fire({
    //           icon: 'error',
    //           title: 'Error',
    //           text: error.message,
    //           timer: 1500,
    //           showConfirmButton: false
    //         });
    //       });
    //     }
    //   });
    // }

    async function confirmList(productId, isListing, button) {
    const action = isListing ? 'List' : 'Unlist';
    const actionEndpoint = isListing ? 'productList' : 'productUnlist';
    
    try {
        // Show loading state
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...`;

        const response = await fetch(`/admin/${actionEndpoint}/${productId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.message || 'Failed to update product status');
        }

        if (data.success) {
            await Swal.fire({
                icon: 'success',
                title: `Product ${action}ed Successfully`,
                showConfirmButton: false,
                timer: 1500
            });
            window.location.reload();
        } else {
            throw new Error(data.message || 'Failed to update product status');
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || `Failed to ${action} product`,
        });
        // Reset button state
        button.disabled = false;
        button.textContent = isListing ? 'LIST' : 'UNLIST';
    }
}

    // Delete Product
    function confirmDelete(productId) {
      Swal.fire({
        title: 'Delete Product',
        text: 'Are you sure you want to delete this product?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#C6A969',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'No'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/admin/delete-product/${productId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ isBlocked: true })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to delete product');
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: 'Product Deleted',
                timer: 1500,
                showConfirmButton: false
              }).then(() => {
                window.location.reload();
              });
            } else {
              throw new Error(data.message || 'Failed to delete product');
            }
          })
          .catch(error => {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: error.message,
              timer: 1500,
              showConfirmButton: false
            });
          });
        }
      });
    }
  </script>
</body>
</html>