<%- include("../../views/partials/user/header") %>
<style>
    body {
        background-color: #f5f5f5;
        color: #333;
    }
    
    .profile-container {
            display: flex;
            min-height: 100vh;
        }
    
    .main-content {
        flex: 1;
        padding: 60px;
    }
    
    .section {
        margin-bottom: 40px;
    }
    
    .section-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .profile-image {
        width: 100px;
        height: 100px;
        background-color: #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        /* overflowaclysm: hidden; */
        cursor: pointer;
    }
    
    .profile-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    #profile-image-input {  
        display: none;
    }
    
    .user-icon {
        width: 60px;
        height: 60px;
        fill: #aaa;
    }
    
    .btn {
        padding: 10px 20px;
        background-color: #d4c276;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }
    
    .btn:hover {
        background-color: #c1af63;
    }
    
    .text-right {
        text-align: right;
    }
    
    .link {
        color: #6e8a9e;
        font-size: 14px;
        text-decoration: none;
        cursor: pointer;
    }
    
    .link:hover {
        text-decoration: underline;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal-image-container {
        max-width: 100%;
        margin-bottom: 20px;
    }
    
    .modal-image-container img {
        width: 100%;
        height: auto;
    }
    
    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    @media (max-width: 768px) {
        .container {
            flex-direction: column;
        }
        
        .main-content {
            padding: 20px 15px;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Include Cropper.js CSS and JS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<body>
    <%- include("../partials/user/profilesidebar") %>
    
    <div class="main-content">
        <div class="section">
            <div class="section-title">BASIC INFO</div>
            
            <form id="profile-form">
                <div class="form-group">
                    <label class="form-label">Profile Image</label>
                    <div class="profile-image" id="profile-image">
                        <% if (user && user.profileImage && user.profileImage !== '') { %>
                            <img src="<%= user.profileImage %>" alt="Profile Image" onerror="this.src='/images/default-profile.jpg'">
                        <% } else { %>
                            <svg class="user-icon" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        <% } %>
                    </div>
                    <input type="file" id="profile-image-input" class="form-control" accept="image/*">
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-control" name="firstName" value="<%= user && user.firstName ? user.firstName : '' %>" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-control" name="lastName" value="<%= user && user.lastName ? user.lastName : '' %>">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" name="phone" value="<%= user && user.phone ? user.phone : '' %>">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" name="username" value="<%= user && user.name ? user.name : '' %>" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <select class="form-control" name="gender">
                            <option value="Not provided" <%= (!user || !user.gender) ? 'selected' : '' %>>Select</option>
                            <option value="Male" <%= user && user.gender === 'Male' ? 'selected' : '' %>>Male</option>
                            <option value="Female" <%= user && user.gender === 'Female' ? 'selected' : '' %>>Female</option>
                            <option value="Other" <%= user && user.gender === 'Other' ? 'selected' : '' %>>Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="text-right">
                    <button type="submit" class="btn">UPDATE DETAILS</button>
                </div>
            </form>
        </div>
    </div>
</body>

    <!-- Image Crop Modal -->
    <div class="modal" id="crop-modal">
        <div class="modal-content">
            <div class="modal-image-container">
                <img id="image-to-crop" src="" alt="Image to crop">
            </div>
            <div class="modal-buttons">
                <button class="btn" id="cancel-crop">Cancel</button>
                <button class="btn" id="save-crop">Save</button>
            </div>
        </div>
    </div>

    <script>
        let cropper = null;
        let croppedImageData = null;

        // Profile image click handler
        document.getElementById('profile-image').addEventListener('click', () => {
            document.getElementById('profile-image-input').click();
        });

        // Image input change handler
        document.getElementById('profile-image-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const modal = document.getElementById('crop-modal');
                    const image = document.getElementById('image-to-crop');
                    image.src = event.target.result;
                    modal.style.display = 'flex';

                    // Initialize Cropper.js
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(image, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 0.8,
                        responsive: true
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // Cancel crop
        document.getElementById('cancel-crop').addEventListener('click', () => {
            const modal = document.getElementById('crop-modal');
            modal.style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            document.getElementById('profile-image-input').value = '';
        });

        // Save cropped image
        document.getElementById('save-crop').addEventListener('click', () => {
            if (cropper) {
                croppedImageData = cropper.getCroppedCanvas().toDataURL('image/jpeg');
                const profileImage = document.getElementById('profile-image');
                profileImage.innerHTML = `<img src="${croppedImageData}" alt="Profile Image">`;
                
                const modal = document.getElementById('crop-modal');
                modal.style.display = 'none';
                cropper.destroy();
                cropper = null;
            }
        });

        // Form submission
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const firstName = document.querySelector('input[name="firstName"]').value;
            const lastName = document.querySelector('input[name="lastName"]').value;
            const phone = document.querySelector('input[name="phone"]').value;
            const username = document.querySelector('input[name="username"]').value;
            const gender = document.querySelector('select[name="gender"]').value;

            // Validate required fields
            if (!firstName || !username) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'First name and username are required'
                });
                return;
            }

            formData.append('firstName', firstName);
            formData.append('lastName', lastName);
            formData.append('phone', phone);
            formData.append('username', username);
            formData.append('gender', gender);

            if (croppedImageData) {
                // Convert base64 to blob
                const response = await fetch(croppedImageData);
                const blob = await response.blob();
                formData.append('profileImage', blob, 'profile.jpg');
            }

            try {
                const response = await fetch('/editProfile', {
                    method: 'PUT',
                    body: formData,
                    credentials: 'include'
                });

                const result = await response.json();
                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Profile updated successfully!',
                        timer: 1500
                    }).then(() => {
                        window.location.reload(); // Refresh to show updated data
                    });
                } else {
                    throw new Error(result.message || 'Failed to update profile');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message
                });
            }
        });
    </script>
