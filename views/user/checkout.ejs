
<%- include("../../views/partials/user/header") %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
        /* * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        } */
        .login-checkmark, .bi-check-circle-fill {
        font-size: 20px;
        vertical-align: middle;
    }
        body {
            background-color: #f8f8f8;
            
        }
        
        .container {
            /* max-width: 1200px; */
            width: 100%;
            margin: 0 auto;
        }
        
        .checkout-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .checkout-header h1 {
            font-size: 32px;
            font-weight: bold;
            margin-top: 70px;
        }
        .login-section {
            background-color: #e6d992;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .shipping-section {
            background-color: #e6d992;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .shipping-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .add-address-btn {
            background-color: #848482;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .add-address-btn:hover {
            background-color: #848482;
        }
        
        .address-message {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            text-align: center;
            color: #666;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .product-table-header {
            background-color: #e6d992;
            padding: 12px 15px;
            text-align: left;
        }
        
        .product-row {
            border-bottom: 1px solid #ddd;
            /* padding: 15px 0; */
            display: flex;
            align-items: center;
        }
        
        .product-image {
            width: 60px;
            margin-right: 15px;
        }
        
        .product-details {
            flex: 1;
        }
        
        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .product-promo {
            color: #27ae60;
            margin-bottom: 5px;
        }
        
        .product-discount {
            color: #333;
        }
        
        .product-price, .product-quantity, .product-total {
            padding-left: 18px;
            text-align: start;
        }
        
        .original-price {
            text-decoration: line-through;
            color: #777;
            font-size: 14px;
        }
        
        .discounted-price {
            font-weight: bold;
        }
        
        .order-summary {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .summary-header {
            background-color: #e6d992;
            padding: 15px;
            font-weight: bold;
        }
        
        .summary-content {
            padding: 15px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .summary-row:last-child {
            border-bottom: none;
            font-weight: bold;
        }
        
        .discount {
            color: #e74c3c;
        }
        
        .shipping {
            color: #27ae60;
        }
        
        .proceed-btn {
            background-color: #e6d992;
            color: #333;
            border: none;
            padding: 15px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 0 0 4px 4px;
            margin-bottom: 30px;
        }
        
        .proceed-btn:hover {
            background-color: #d8cb84;
        }
        .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .modal-title {
        font-weight: 600;
        color: #333;
    }
    .modal-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    .form-control:focus {
        border-color: #d4c276;
        box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
    }
    .separator {
        height: 1px;
        background-color: #dee2e6;
        margin: 20px 0;
    }
    .btn-cancel {
        background-color: #fff;
        color: #6c757d;
        border: 1px solid #6c757d;
    }
    .btn-save {
        background-color: #d4c276;
        border-color: #d4c276;
        color: white;
    }
    .required-field::after {
        content: " *";
        color: red;
    }
    .alert {
        padding: 10px;
        background-color: #f8d7da;
        color: #721c24;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    .address-card {
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        margin-bottom: 15px;
        overflow: hidden;
    }
    .address-info {
        padding: 20px;
        position: relative;
    }
    .address-type {
        position: absolute;
        top: 15px;
        right: 15px;
        background-color: #f3f4f6;
        padding: 3px 10px;
        border-radius: 4px;
        font-size: 12px;
        color: #616161;
    }
    .address-name {
    display: flex;
    align-items: center;
    font-weight: 600;
    margin-bottom: 10px;
    color: #424242;
}
.select-address {
    margin-right: 10px;
}
    .address-details {
        color: #666;
        line-height: 1.5;
        margin-bottom: 15px;
    }
    .address-phone {
        color: #666;
        margin-top: 8px;
    }
    .address-actions {
        display: flex;
        border-top: 1px solid #e0e0e0;
    }
    .action-btn {
        flex: 1;
        text-align: center;
        padding: 12px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 500;
        color: #d4c276;
        transition: background-color 0.2s;
    }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .product-table-header {
                display: none;
            }
            
            .product-row {
                flex-direction: column;
                padding: 15px;
            }
            
            .product-image {
                margin-bottom: 10px;
            }
            
            .product-price, .product-quantity, .product-total {
                width: 100%;
                text-align: left;
                /* padding: 5px 0; */
                padding-left: 20px;
            }
            
            .product-price::before {
                content: "Price: ";
                font-weight: bold;
            }
            
            .product-quantity::before {
                content: "Quantity: ";
                font-weight: bold;
            }
            
            .product-total::before {
                content: "Total: ";
                font-weight: bold;
            }
    
    
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="checkout-header">
            <h1>CHECKOUT</h1>
        </div>

        <div class="login-section">
    <div class="shipping-title">LOGIN
        <% if (user) { %>
            <i class="bi bi-check-circle-fill" style="color: #27ae60; margin-left: 10px;"></i>
        <% } %></div>
    <button class="add-address-btn" data-bs-toggle="modal" data-bs-target="#changeUserModal">Change User +</button>
</div>
        
        <div class="shipping-section">
            <div class="shipping-title">SHIPPING ADDRESS
                <% if (addresses && addresses.some(address => address.isDefault)) { %>
            <i class="bi bi-check-circle-fill shipping-checkmark" style="color: #27ae60; margin-left: 10px;"></i>
        <% } %>
            </div>
            <button class="add-address-btn" data-bs-toggle="modal" data-bs-target="#addressModal">Add Address +</button>
        </div>
        
        <div class="address-section">
            <% if (addresses && addresses.length > 0) { %>
                <% addresses.forEach(address => { %>
                    <div class="address-card">
                        <div class="address-info">
                            <span class="address-type"><%= address.addressType.toUpperCase() %></span>
                            <h3 class="address-name">
                        <input type="radio" name="selectedAddress" value="<%= address._id %>" class="select-address" <%= address.isDefault ? 'checked' : '' %>>
                        <%= address.name %>
                    </h3>
                            <div class="address-details">
                                <%= address.address %><br>
                                <%= address.landmark %><br>
                                <%= address.city %> - <%= address.pincode %><br>
                                <%= address.state %>
                            </div>
                            <div class="address-phone">Mobile: <%= address.phone %></div>
                            <% if (address.isDefault) { %>
                                <div class="address-default" style="color: #d4c276; font-weight: bold;">Default Address</div>
                            <% } %>
                            <% if (address.addressType === 'office') { %>
                                <div class="address-weekend">
                                    Weekend Availability: 
                                    <%= address.openSaturday ? 'Saturday Open' : 'Saturday Closed' %>,
                                    <%= address.openSunday ? 'Sunday Open' : 'Sunday Closed' %>
                                </div>
                            <% } %>
                        </div>
                        <div class="address-actions">
                            <button class="action-btn edit-address" data-address-id="<%= address._id %>">EDIT</button>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <p>No addresses saved yet.</p>
            <% } %>
        </div>
        
        <table class="product-table">
            <thead>
                <tr>
                    <th class="product-table-header" style="width: 50%;">Product Details</th>
                    <th class="product-table-header" style="width: 15%;">Price</th>
                    <th class="product-table-header" style="width: 15%;">Quantity</th>
                    <th class="product-table-header" style="width: 10%;">Total</th>
                </tr>
            </thead>
            <tbody>
                <% if (cartItems.length > 0) { %>
            <% cartItems.forEach(item => { %>
                <% if (item.productId) { %>
                <tr>
                    <td colspan="1">
                        <div class="product-row">
                            <img src="<%= item.productId.productImage[0] %>" alt="<%= item.productId.productName %>" class="product-image">
                            <div class="product-details">
                                <div class="product-name"><%= item.productId.productName %></div>
                                    <div class="product-promo"><%= item.productId.category.name %></div>
                                    <div class="product-discount">Brand: <%= item.productId.brand.name %></div>
                            </div>
                            <td>
                            <div class="product-price">
                                <div class="discounted-price">₹<%= item.price.toLocaleString('en-IN') %></div>
                                <% if (item.offer || (item.couponDiscount && item.couponDiscount > 0)) { %>
                        <div class="product-promo">
                          <% if (item.offer) { %>
                            <%= item.offer.discount %>% OFF (<%= item.offer.offerName %>)
                          <% } %>
                          <% if (item.couponDiscount && item.couponDiscount > 0) { %>
                            <% if (item.offer) { %> + <% } %>
                            Coupon Discount Applied
                          <% } %>
                        </div>
                      <% } %>
                            </div>
                            </td>
                            <td class="product-quantity"><%= item.quantity %></td>
                            <td class="product-total">
                                <% if (item.offer) { %>
          <p class="discount-tag">
            <%= item.offer.discount %>% OFF (<%= item.offer.offerName %>)
          </p>
          <p>
            <span class="sale-price">₹<span class="item-total"><%= item.totalPrice.toLocaleString('en-IN') %></span></span>
          </p>
        <% } else { %>
          <!-- No offer, show regular price -->
          <p>
            <span class="sale-price">₹<span class="item-total"><%= item.totalPrice.toLocaleString('en-IN') %></span></span>
          </p>
        <% } %>
                            </td>
                        </div>
                    </td>
                </tr>
                <% } %>
            <% }) %>
        <% } else { %>
            <tr>
                <td colspan="4" class="address-message">Your cart is empty.</td>
            </tr>
        <% } %>
            </tbody>
        </table>
        
        <div style="display: flex; justify-content: flex-end;">
            <div style="width: 100%; max-width: 350px;">
                <div class="order-summary">
                    <div class="summary-header">Order Summary</div>
                    <div class="summary-content">
                        <% if (cartItems.length > 0) { %>
                        <div class="summary-row">
                            <div>Subtotal</div>
                            <div>₹<%= cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0).toLocaleString('en-IN') %></div>
                        </div>
                        <div class="summary-row">
                            <div>Discount</div>
                            <div class="discount">-₹<%= offerDiscount %></div>
                        </div>
                        <div class="summary-row">
                            <div>Coupon Discount</div>
                            <div class="discount">-₹<%= couponDiscount %></div>
                        </div>
                        <div class="summary-row">
                            <div>Shipping</div>
                            <div class="shipping">FREE</div>
                        </div>
                        <div class="summary-row">
                            <div>Total Payable</div>
                            <div>₹<%= finalTotal.toLocaleString('en-IN') %></div>
                        </div>
                        <% } else { %>
                            <div class="summary-row">
                                <div>No items in cart</div>
                                <div>-</div>
                            </div>
                        <% } %>
                    </div>
                </div>
                <button class="proceed-btn">Proceed to Payment</button>
            </div>
        </div>
    </div>

    <!-- add address modal -->
   <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addressModalLabel">ADD NEW ADDRESS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addressForm">
                        <div class="mb-3">
                            <label for="name" class="form-label required-field">Name</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="mobile" class="form-label required-field">Mobile</label>
                            <input type="tel" class="form-control" id="mobile" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="pincode" class="form-label required-field">Pincode</label>
                                <input type="text" class="form-control" id="pincode" required>
                            </div>
                            <div class="col-md-6">
                                <label for="state" class="form-label required-field">State</label>
                                <input type="text" class="form-control" id="state" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label required-field">Address (House No, Building, Street, Area)</label>
                            <input type="text" class="form-control" id="address" required>
                        </div>
                        <div class="mb-3">
                            <label for="locality" class="form-label required-field">Locality/Town</label>
                            <input type="text" class="form-control" id="locality" required>
                        </div>
                        <div class="mb-3">
                            <label for="city" class="form-label required-field">City/District</label>
                            <input type="text" class="form-control" id="city" required>
                        </div>
                        <div class="separator"></div>
                        <div class="mb-3">
                            <label class="form-label required-field">Type of Address</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="addressType" id="home" value="home" checked>
                                <label class="form-check-label" for="home">Home</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="addressType" id="office" value="office">
                                <label class="form-check-label" for="office">Office</label>
                            </div>
                        </div>
                        <div class="mb-3" id="weekendOptions">
                            <label class="form-label">Is your office open on weekends?</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="saturday">
                                <label class="form-check-label" for="saturday">Open on Saturday</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sunday">
                                <label class="form-check-label" for="sunday">Open on Sunday</label>
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="defaultAddress">
                            <label class="form-check-label" for="defaultAddress">Make this as my default address</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">CANCEL</button>
                    <button type="submit" form="addressForm" class="btn btn-save">SAVE</button>
                </div>
            </div>
        </div>
    </div>


    <!-- New Change User Modal -->
<div class="modal fade" id="changeUserModal" tabindex="-1" aria-labelledby="changeUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeUserModalLabel">Change User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changeUserForm">
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label ">Phone Number</label>
                        <input type="tel" class="form-control" id="phoneNumber" value="<%= user && user.phone ? user.phone : 'Not provided' %>" readonly>
                    </div>
                    <div class="mb-3">
                        <a href="/logout" class="text-decoration-none">Logout & Sign in to another account</a>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="changeUserForm" class="btn btn-save"><a href="/checkout">Continue Checkout</a></button>
            </div>
        </div>
    </div>
</div>

</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const officeRadio = document.getElementById('office');
    const homeRadio = document.getElementById('home');
    const weekendOptions = document.getElementById('weekendOptions');
    const pincodeInput = document.getElementById('pincode');
    const cityInput = document.getElementById('city');
    const stateInput = document.getElementById('state');
    const addressForm = document.getElementById('addressForm');
    const modalTitle = document.getElementById('addressModalLabel');
    const saveButton = document.querySelector('.btn-save');

    // Toggle weekend options visibility
    weekendOptions.style.display = homeRadio.checked ? 'none' : 'block';
    officeRadio.addEventListener('change', function() {
        weekendOptions.style.display = 'block';
    });
    homeRadio.addEventListener('change', function() {
        weekendOptions.style.display = 'none';
    });

    // Pincode API integration
    pincodeInput.addEventListener('input', async function() {
        const pincode = pincodeInput.value.trim();
        
        // Only make API call if we have exactly 6 digits
        if (pincode.length === 6 && /^\d{6}$/.test(pincode)) {
            try {
                // Show loading state
                cityInput.value = "Loading...";
                stateInput.value = "Loading...";
                
                const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
          
                if (data[0].Status === 'Success' && data[0].PostOffice && data[0].PostOffice.length > 0) {
                    // Take the first post office entry
                    const postOffice = data[0].PostOffice[0];
                    
                    // Update fields - handle possible undefined values
                    cityInput.value = postOffice.District || postOffice.Block || '';
                    stateInput.value = postOffice.State || '';
                    
                  
                } else {
                    cityInput.value = '';
                    stateInput.value = '';
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid Pincode',
                        text: 'No data found for this pincode'
                    });
                }
            } catch (error) {
                console.error('Error fetching pincode data:', error);
                cityInput.value = '';
                stateInput.value = '';
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message.includes('Failed to fetch') 
                        ? 'Network error. Please check your connection.'
                        : 'Error fetching pincode data. Please try again.'
                });
            }
        } else if (pincode.length === 0) {
            // Clear fields if pincode is empty
            cityInput.value = '';
            stateInput.value = '';
        }
    });

    // Form submission handler
    addressForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        const addressId = document.getElementById('addressId')?.value;
        const isEditMode = !!addressId;
        const endpoint = isEditMode ? `/editAddress/${addressId}` : '/addAddress';
        const method = isEditMode ? 'PUT' : 'POST';

        const formData = {
            name: document.getElementById('name').value.trim(),
            mobile: document.getElementById('mobile').value.trim(),
            pincode: document.getElementById('pincode').value.trim(),
            state: document.getElementById('state').value.trim(),
            address: document.getElementById('address').value.trim(),
            locality: document.getElementById('locality').value.trim(),
            city: document.getElementById('city').value.trim(),
            addressType: document.querySelector('input[name="addressType"]:checked').value,
            openSaturday: document.getElementById('saturday').checked,
            openSunday: document.getElementById('sunday').checked,
            isDefault: document.getElementById('defaultAddress').checked
        };

        try {
            const response = await fetch(endpoint, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: result.message,
                    timer: 1500
                }).then(() => {
                    window.location.href = '/checkout';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: result.message
                });
                if (result.message.includes('blocked')) {
                    setTimeout(() => {
                        window.location.href = '/login?message=Your account is blocked. Please contact support.';
                    }, 1500);
                }
            }
        } catch (error) {
            console.error(`Error ${isEditMode ? 'updating' : 'adding'} address:`, error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Failed to ${isEditMode ? 'update' : 'add'} address. Please try again.`
            });
        }
    });

    // Edit address functionality
    document.querySelectorAll('.edit-address').forEach(button => {
        button.addEventListener('click', async function() {
            const addressId = this.dataset.addressId;
            
            try {
                // Fetch the address details
                const response = await fetch(`/getAddress/${addressId}`);
                const result = await response.json();
                
                if (result.success) {
                    const address = result.address;
                    
                    // Populate the form fields
                    document.getElementById('name').value = address.name;
                    document.getElementById('mobile').value = address.phone;
                    document.getElementById('pincode').value = address.pincode;
                    document.getElementById('state').value = address.state;
                    document.getElementById('address').value = address.address;
                    document.getElementById('locality').value = address.landmark;
                    document.getElementById('city').value = address.city;
                    
                    // Set address type radio button
                    if (address.addressType === 'home') {
                        document.getElementById('home').checked = true;
                        document.getElementById('weekendOptions').style.display = 'none';
                    } else {
                        document.getElementById('office').checked = true;
                        document.getElementById('weekendOptions').style.display = 'block';
                        document.getElementById('saturday').checked = address.openSaturday;
                        document.getElementById('sunday').checked = address.openSunday;
                    }
                    
                    // Set default checkbox
                    document.getElementById('defaultAddress').checked = address.isDefault;
                    
                    // Update modal title and button text
                    modalTitle.textContent = 'EDIT ADDRESS';
                    saveButton.textContent = 'UPDATE';
                    
                    // Add a hidden field to store the address ID
                    let addressIdField = document.getElementById('addressId');
                    if (!addressIdField) {
                        addressIdField = document.createElement('input');
                        addressIdField.type = 'hidden';
                        addressIdField.id = 'addressId';
                        addressForm.appendChild(addressIdField);
                    }
                    addressIdField.value = addressId;
                    
                    // Open the modal
                    const addressModal = new bootstrap.Modal(document.getElementById('addressModal'));
                    addressModal.show();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: result.message
                    });
                }
            } catch (error) {
                console.error('Error fetching address details:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load address details. Please try again.'
                });
            }
        });
    });
});

// Address selection handler
document.querySelectorAll('.select-address').forEach(radio => {
    radio.addEventListener('change', function() {
        // Remove existing checkmark from shipping-section
        const existingCheckmark = document.querySelector('.shipping-section .shipping-checkmark');
        if (existingCheckmark) {
            existingCheckmark.remove();
        }
        // Add new checkmark to shipping-section
        if (this.checked) {
            const shippingTitle = document.querySelector('.shipping-section .shipping-title');
            const checkmarkIcon = document.createElement('i');
            checkmarkIcon.className = 'bi bi-check-circle-fill shipping-checkmark';
            checkmarkIcon.style.color = '#27ae60';
            checkmarkIcon.style.marginLeft = '10px';
            shippingTitle.appendChild(checkmarkIcon);
        }
    });
});

// Initialize checkmark on page load
function initializeShippingCheckmark() {
    const selectedAddress = document.querySelector('.select-address:checked');
    const existingCheckmark = document.querySelector('.shipping-section .shipping-checkmark');
    if (selectedAddress && !existingCheckmark) {
        const shippingTitle = document.querySelector('.shipping-section .shipping-title');
        const checkmarkIcon = document.createElement('i');
        checkmarkIcon.className = 'bi bi-check-circle-fill shipping-checkmark';
        checkmarkIcon.style.color = '#27ae60';
        checkmarkIcon.style.marginLeft = '10px';
        shippingTitle.appendChild(checkmarkIcon);
    } else if (!selectedAddress && existingCheckmark) {
        existingCheckmark.remove();
    }
}
initializeShippingCheckmark();

document.querySelector('.proceed-btn').addEventListener('click', async function (event) {
    event.preventDefault();

    // Check if user is logged in
    const user = '<%= user ? user._id : "" %>';
    if (!user) {
        Swal.fire({
            icon: 'error',
            title: 'Not Logged In',
            text: 'Please log in to proceed to payment.',
        });
        return;
    }


    const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
    if (!selectedAddress) {
        Swal.fire({
            icon: 'error',
            title: 'No Address Selected',
            text: 'Please select a shipping address to proceed to payment.',
        });
        return;
    }

    const addressId = selectedAddress.value;


    // Show loading state
    const proceedBtn = document.querySelector('.proceed-btn');
    const originalText = proceedBtn.textContent;
    proceedBtn.textContent = 'Processing...';
    proceedBtn.disabled = true;

    try {
        const response = await fetch('/selectAddress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ addressId }),
        });

       
        
        // Check if response is ok
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();


        if (result.success) {
            // Successfully selected address, redirect to payment
            window.location.href = '/payment';
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: result.message || 'Failed to select address. Please try again.',
            });
        }
    } catch (error) {
        console.error('Error selecting address:', error);
        
        // More specific error messages
        let errorMessage = 'Failed to select address. Please try again.';
        
        if (error.message.includes('Failed to fetch')) {
            errorMessage = 'Network error. Please check your connection and try again.';
        } else if (error.message.includes('HTTP error')) {
            errorMessage = 'Server error. Please try again later.';
        }
        
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: errorMessage,
        });
    } finally {
        // Restore button state
        proceedBtn.textContent = originalText;
        proceedBtn.disabled = false;
    }
});

</script>

<%- include("../../views/partials/user/footer") %>