<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timeluxe - Sign Up</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .container {
        max-width: 900px;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
      }
      .left-panel {
        padding: 40px;
      }
      .brand {
        font-size: 2rem;
        font-family: fantasy;
      }
      .form-control {
        border-radius: 5px;
      }
      .watch-image {
        width: 50%;
        background: url("images/signup.jpg") no-repeat center;
        background-size: cover;
      }
      .error-message {
        color: red;
        font-size: 0.75rem;
        display: none;
      }
      .success-message {
        color: green;
        font-size: 0.75rem;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="d-flex justify-content-center align-items-center vh-100">
      <div class="container d-flex shadow">
        <!-- Left Panel -->
        <div class="left-panel w-50">
          <h2 class="brand">Timeluxe</h2>
          <h4>Create an account</h4>
          <p>Already have an account? <a href="/login">Sign in</a></p>
          <form id="signform" method="post" action="/signup">
            <div class="mb-3">
              <input
                type="text"
                class="form-control"
                name="name"
                id="name"
                placeholder="Full Name"
                required
              />
              <div id="error-name" class="error-message"></div>
            </div>
            <div class="mb-3">
              <input
                type="email"
                class="form-control"
                name="email"
                id="email"
                placeholder="Email Address"
                required
              />
              <div id="error-email" class="error-message"></div>
            </div>
            <div class="mb-3">
              <input
                type="text"
                class="form-control"
                name="phone"
                id="phone"
                placeholder="Phone Number (10 digits)"
                required
              />
              <div id="error-phone" class="error-message"></div>
            </div>
            <div class="mb-3">
              <input
                type="password"
                class="form-control"
                name="password"
                id="password"
                placeholder="Password"
                required
              />
              <div id="error-password" class="error-message"></div>
              <small class="text-muted"
                >Passwords must be at least 8 characters.</small
              >
            </div>
            <div class="mb-3">
              <input
                type="password"
                class="form-control"
                name="cPassword"
                id="confirm-password"
                placeholder="Confirm Password"
                required
              />
              <div id="error-confirm" class="error-message"></div>
            </div>
            <div class="mb-3">
              <input
                type="text"
                class="form-control"
                name="referralCode"
                id="referral-code"
                placeholder="Referral Code (Optional)"
              />
              <div id="error-referral" class="error-message"></div>
              <div id="success-referral" class="success-message"></div>
              <small class="text-muted"
                >Enter a valid referral code to get a bonus!</small
              >
            </div>
            <% if (locals.message && message.length > 0) { %>
            <div class="alert alert-danger text-center"><%= message %></div>
            <% } %>
            <div class="form-check mb-3">
              <input
                type="checkbox"
                class="form-check-input"
                id="savePassword"
              />
              <label class="form-check-label" for="savePassword"
                >Save the password</label
              >
            </div>
            <button type="submit" class="btn btn-danger w-100">
              Create an account
            </button>
            <div class="text-center mt-3">or continue with</div>
            <a href="/auth/google" class="btn btn-light w-100 mt-2">
              <img src="images/googlesignup.png" width="20" /> Google
            </a>
          </form>
          <p class="mt-3"><a href="#">Need help?</a></p>
        </div>
        <!-- Right Panel (Watch Image) -->
        <div class="watch-image"></div>
      </div>
    </div>

    <script>
      // DOM Elements
      const nameid = document.getElementById("name");
      const emailid = document.getElementById("email");
      const phoneid = document.getElementById("phone");
      const passid = document.getElementById("password");
      const cPassid = document.getElementById("confirm-password");
      const referralid = document.getElementById("referral-code");

      const errorName = document.getElementById("error-name");
      const errorEmail = document.getElementById("error-email");
      const errorPhone = document.getElementById("error-phone");
      const errorPassword = document.getElementById("error-password");
      const errorConfirm = document.getElementById("error-confirm");
      const errorReferral = document.getElementById("error-referral");
      const successReferral = document.getElementById("success-referral");
      const signform = document.getElementById("signform");

      // Get referral code from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const refCode = urlParams.get("ref");
      if (refCode) {
        referralid.value = refCode;
        console.log("Referral code from URL:", refCode);
      }

      // Validation Functions
      function validateName() {
        const nameVal = nameid.value.trim();
        if (nameVal === "") {
          errorName.style.display = "block";
          errorName.innerHTML = "Name is required";
          return false;
        } else if (nameVal.length < 3) {
          errorName.style.display = "block";
          errorName.innerHTML = "Name must be at least 3 characters";
          return false;
        } else {
          errorName.style.display = "none";
          errorName.innerHTML = "";
          return true;
        }
      }

      function validateEmail() {
        const emailVal = emailid.value.trim();
        const emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!emailPattern.test(emailVal)) {
          errorEmail.style.display = "block";
          errorEmail.innerHTML = "Invalid email format";
          return false;
        } else {
          errorEmail.innerHTML = "";
          // AJAX call to check email uniqueness
          fetch("/check-email", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: emailVal }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.exists) {
                errorEmail.style.display = "block";
                errorEmail.innerHTML = "Email already registered";
                return false;
              } else {
                errorEmail.style.display = "none";
                errorEmail.innerHTML = "";
                return true;
              }
            })
            .catch((err) => console.error("Email check failed:", err));
          return true;
        }
      }

      function validatePhone() {
        const phoneVal = phoneid.value.trim();
        if (phoneVal === "") {
          errorPhone.style.display = "block";
          errorPhone.innerHTML = "Phone number is required";
          return false;
        } else if (phoneVal.length !== 10 || isNaN(phoneVal)) {
          errorPhone.style.display = "block";
          errorPhone.innerHTML = "Enter a valid 10-digit phone number";
          return false;
        } else {
          errorPhone.style.display = "none";
          errorPhone.innerHTML = "";
          return true;
        }
      }

      function validatePassword() {
        const passVal = passid.value;
        const alpha = /[a-zA-Z]/;
        const digit = /\d/;
        if (passVal.length < 8) {
          errorPassword.style.display = "block";
          errorPassword.innerHTML = "Should contain at least 8 characters";
          return false;
        } else if (!alpha.test(passVal) || !digit.test(passVal)) {
          errorPassword.style.display = "block";
          errorPassword.innerHTML = "Should contain numbers and alphabets";
          return false;
        } else {
          errorPassword.style.display = "none";
          errorPassword.innerHTML = "";
          return true;
        }
      }

      function validateConfirmPassword() {
        const passVal = passid.value;
        const cpassVal = cPassid.value;
        if (passVal !== cpassVal) {
          errorConfirm.style.display = "block";
          errorConfirm.innerHTML = "Passwords do not match";
          return false;
        } else {
          errorConfirm.style.display = "none";
          errorConfirm.innerHTML = "";
          return true;
        }
      }

      function validateReferralCode() {
        const refVal = referralid.value.trim();
        if (refVal === "") {
          errorReferral.style.display = "none";
          successReferral.style.display = "none";
          return true; // Optional field
        }

        if (refVal.length < 6) {
          errorReferral.style.display = "block";
          errorReferral.innerHTML = "Invalid referral code";
          successReferral.style.display = "none";
          return false;
        }

        // AJAX call to validate referral code
        fetch("/validate-referral", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ referralCode: refVal.toUpperCase() }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.valid) {
              errorReferral.style.display = "none";
              successReferral.style.display = "block";
              successReferral.innerHTML = `âœ“ Valid referral code from ${data.referrerName}`;
              return true;
            } else {
              errorReferral.style.display = "block";
              errorReferral.innerHTML = "Invalid referral code";
              successReferral.style.display = "none";
              return false;
            }
          })
          .catch((err) => {
            console.error("Referral validation failed:", err);
            return true; // Don't block submission on error
          });
        return true;
      }

      // Real-time Validation
      nameid.addEventListener("input", validateName);
      emailid.addEventListener("input", validateEmail);
      phoneid.addEventListener("input", validatePhone);
      passid.addEventListener("input", () => {
        validatePassword();
        validateConfirmPassword();
      });
      cPassid.addEventListener("input", validateConfirmPassword);
      referralid.addEventListener("input", validateReferralCode);

      // Form Submission
      signform.addEventListener("submit", function (e) {
        const isNameValid = validateName();
        const isEmailValid = validateEmail();
        const isPhoneValid = validatePhone();
        const isPasswordValid = validatePassword();
        const isConfirmValid = validateConfirmPassword();
        const isReferralValid = validateReferralCode();

        if (
          !isNameValid ||
          !isEmailValid ||
          !isPhoneValid ||
          !isPasswordValid ||
          !isConfirmValid
        ) {
          e.preventDefault();
        }
      });
    </script>
  </body>
</html>
