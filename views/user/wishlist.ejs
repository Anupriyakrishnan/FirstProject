<%- include("../../views/partials/user/header") %>

<style>
  /* * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
  } */

  body {
    background-color: #ffffff;
  }

  .wishlist-container {
    width: 100%;
    margin: 50px auto;
  }

  .wishlist-header {
    text-align: center;
    padding: 20px 0px;
    font-size: 28px;
    font-weight: bold;
    color: #000;
  }

  .wishlist-table {
    width: 100%;
    border-collapse: collapse;
  }

  .table-header {
    background-color: #e2d9b2;
    padding: 15px;
    color: #333;
    font-weight: normal;
    text-align: left;
  }

  .product-column {
    width: 60%;
  }

  .price-column {
    width: 20%;
  }

  .action-column {
    width: 20%;
  }

  .wishlist-item {
    border-bottom: 1px solid #eee;
  }

  .product-container {
    display: flex;
    padding: 20px 0;
    align-items: center;
  }

  .remove-button {
    background: #f0f0f0;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-right: 10px;
    font-size: 18px;
  }

  .product-image {
    width: 100px;
    height: 120px;
    margin-right: 20px;
    object-fit: contain;
  }

  .product-info {
    display: flex;
    flex-direction: column;
  }

  .product-title {
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 5px;
    color: #000;
  }

  .product-specs {
    color: #666;
    font-size: 14px;
    margin-bottom: 5px;
    line-height: 1.4;
  }

  .product-offer {
    color: #22a858;
    font-size: 14px;
  }

  .price-info {
    display: flex;
    align-items: center;
  }

  .current-price {
    font-size: 18px;
    font-weight: bold;
    margin-top: 60px;
  }

  .original-price {
    text-decoration: line-through;
    color: #888;
    font-size: 16px;
    margin-left: 5px;
  }

  .add-cart-button {
    background-color: #22a858;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: normal;
    transition: background-color 0.2s;
  }

  .add-cart-button:hover {
    background-color: #1c9149;
  }

  .center {
    text-align: center;
  }

  @media screen and (max-width: 768px) {
    .wishlist-header {
      font-size: 24px;
      padding: 15px 0;
    }

    .table-header {
      padding: 10px;
      font-size: 14px;
    }

    .product-title {
      font-size: 16px;
    }

    .product-specs {
      font-size: 12px;
    }

    .current-price,
    .original-price {
      font-size: 14px;
    }

    .add-cart-button {
      padding: 8px 15px;
      font-size: 14px;
    }
  }

  @media screen and (max-width: 600px) {
    .wishlist-table thead {
      display: none;
    }

    .wishlist-table,
    .wishlist-table tbody,
    .wishlist-table tr,
    .wishlist-table td {
      display: block;
      width: 100%;
    }

    .wishlist-item {
      padding: 15px 0;
      position: relative;
    }

    .product-container {
      flex-direction: column;
      align-items: flex-start;
      padding: 10px 0;
    }

    .product-title {
      font-size: 16px;
      margin-top: 10px;
    }

    .remove-button {
      position: absolute;
      top: 15px;
      right: 5px;
    }

    .product-image {
      margin-left: 40px;
    }

    .price-info {
      padding: 10px 0;
      justify-content: flex-end;
    }

    .action-column {
      text-align: center;
      padding: 10px 0;
    }

    .add-cart-button {
      width: 100%;
    }
  }

  @media screen and (max-width: 480px) {
    body {
      padding: 10px 5px;
    }

    .wishlist-header {
      font-size: 20px;
    }

    .product-specs {
      font-size: 11px;
    }
  }
</style>

<body>
  <div class="container wishlist-container">
    <h2 class="text-center mb-2">MY WISHLIST</h2>

    <table class="wishlist-table">
      <thead>
        <tr>
          <th class="table-header product-column">Product Details</th>
          <th class="table-header price-column">Price</th>
          <th class="table-header action-column center">Action</th>
        </tr>
      </thead>
      <tbody>
        <% if (wishlist.length > 0) { %> <% wishlist.forEach(product => { %>
        <tr class="wishlist-item">
          <td class="product-column">
            <div class="product-container">
              <button
                class="remove-button"
                onclick="removeFromWishlist('<%= product._id %>')"
              >
                ×
              </button>
              <img
                src="<%= product.productImage[0] %>"
                class="product-image"
                alt="<%= product.productName %>"
              />
              <div class="product-info">
                <h3 class="product-title"><%= product.productName %></h3>
                <p class="product-specs">
                  <%= product.category.name %><br />
                  <%= product.brand.name %>
                </p>
                <% if (product.offer) { %>
                <p class="product-offer">
                  <%= product.offer.discount %>% OFF (<%=
                  product.offer.offerName %>)
                </p>
                <% } %>
              </div>
            </div>
          </td>
          <td class="price-column price-info center">
            <% if (product.offer) { %>
            <span class="original-price"
              >₹<%= product.salePrice.toLocaleString('en-IN') %></span
            >
            <span class="discounted-price"
              >₹<%= product.discountedPrice.toLocaleString('en-IN') %></span
            >
            <% } else { %>
            <span class="current-price"
              >₹<%= product.salePrice.toLocaleString('en-IN') %></span
            >
            <% } %>
          </td>
          <td class="action-column center">
            <button
              class="add-cart-button"
              onclick="addToCart('<%= product._id %>', this)"
            >
              Add to Cart
            </button>
          </td>
        </tr>
        <% }) %> <% } else { %>
        <tr>
          <td colspan="3" class="center">
            <p>No items found in wishlist</p>
          </td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    async function removeFromWishlist(productId) {
      try {
        const response = await fetch("/remove-from-wishlist", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productId }),
        });
        const data = await response.json();
        if (response.ok) {
          Swal.fire({
            icon: "success",
            title: "Removed",
            text: data.message,
            showConfirmButton: true,
          }).then(() => {
            const wishlistItem = document
              .querySelector(
                `.remove-button[onclick="removeFromWishlist('${productId}')"]`
              )
              .closest(".wishlist-item");
            wishlistItem.style.opacity = "0.5";
            setTimeout(() => {
              wishlistItem.remove();
              if (!document.querySelector(".wishlist-item")) {
                document.querySelector(".wishlist-table tbody").innerHTML = `
                  <tr>
                    <td colspan="3" class="center">
                      <p>No items found in wishlist</p>
                    </td>
                  </tr>
                `;
              }
            }, 500);
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: data.message || "Failed to remove from wishlist",
          });
        }
      } catch (error) {
        console.error("Error:", error);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "An error occurred while removing from wishlist",
        });
      }
    }

    async function addToCart(productId, button) {
      try {
        // Show loading state
        const originalText = button.textContent;
        button.textContent = "Adding...";
        button.disabled = true;

        const response = await fetch("/add-to-cart", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productId, quantity: 1 }),
          credentials: "same-origin", // Include cookies for session
        });

        const data = await response.json();

        if (response.ok) {
          Swal.fire({
            icon: "success",
            title: "Added to Cart",
            text: data.message,
            showConfirmButton: false,
            timer: 1500,
          }).then(() => {
            button.textContent = "Go to Cart";
            button.style.backgroundColor = "#168b41";
            button.disabled = false;
            button.onclick = () => {
              window.location.href = "/cart";
            };
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: data.message || "Failed to add to cart",
          });
          button.textContent = originalText;
          button.disabled = false;
        }
      } catch (error) {
        console.error("Error:", error);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "An error occurred while adding to cart",
        });
        button.textContent = "Add to Cart";
        button.disabled = false;
      }
    }
  </script>
</body>

<%- include("../../views/partials/user/footer") %>
